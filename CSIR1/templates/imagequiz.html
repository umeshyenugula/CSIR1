<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Image Round</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f2f2;
      margin: 0;
      padding: 0;
      text-align: center;
    }

    .header {
      background: #cfc9c9;
      padding: 20px;
      font-size: 2rem;
      font-weight: bold;
      color: #0c056d;
    }

    .question-box {
      margin: 30px auto;
      width: 60%;
      background: linear-gradient(to bottom, #fffdf7, #dedcd1);
      padding: 100px 200px;
      border-radius: 20px;
      text-align: left;
    }

    .question {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 20px;
      text-align: center;
    }

    .question img {
      max-width: 100%;
      border-radius: 10px;
    }

    .options label {
      display: block;
      margin: 12px 0;
      font-size: 1.2rem;
    }

    .footer {
      margin-top: 20px;
      display: flex;
      justify-content: space-around;
      width: 60%;
      margin-left: auto;
      margin-right: auto;
    }

    .button, .timer {
      background: #d1caca;
      border-radius: 20px;
      padding: 15px 45px;
      font-size: 1rem;
      cursor: pointer;
    }

    input[type="radio"] {
      margin-right: 10px;
    }
  </style>
</head>
<body>

<div class="header">Sequence Event Round 1 - Image Quiz</div>

<div class="question-box">
  <div class="question" id="questionBox">
    <img id="questionImage" src="" alt="Question Image" />
  </div>
  <form id="questionForm">
    <div class="options" id="optionsList"></div>
  </form>
</div>

<div class="footer">
  <div class="timer" id="timer">Time Left: 45</div>
  <button class="button" onclick="submitAnswer()">Submit</button>
</div>

<div id="resultBox" style="display: none;">
  <div id="resultHeader" style="background: #ccc; padding: 20px; font-size: 2rem; font-weight: bold; color: white;">
    Result Of the Question.
  </div>
  <div style="margin-top: 40px;">
    <div style="
      margin: 0 auto;
      width: 60%;
      background: linear-gradient(to bottom, #fffdf7, #dedcd1);
      padding: 60px;
      border-radius: 25px;
      font-size: 2rem;
      font-weight: bold;
      color: #444;
    " id="resultMessage">
      {{Result}}
    </div>
  </div>
  <br>
  <button class="button" onclick="window.location.href='/return'">Return to Dashboard</button>
</div>

<script>
  const TOTAL_TIME = 45; 
  const TIMER_KEY = "image_timer_start";

  let timer;
  let timeLeft = TOTAL_TIME;

  function startTimer(startTimestamp) {
    clearInterval(timer);

    timer = setInterval(() => {
      const now = Date.now();
      const elapsed = Math.floor((now - startTimestamp) / 1000);
      timeLeft = TOTAL_TIME - elapsed;

      document.getElementById('timer').textContent = `Time Left: ${timeLeft}`;

      if (timeLeft <= 0) {
        clearInterval(timer);
        submitAnswer(); 
      }
    }, 1000);
  }

  function loadQuestion() {
    fetch('/image/get-question')
      .then(res => res.json())
      .then(data => {

        document.getElementById('questionImage').src = data.image;


        const optionsHTML = data.options.map(opt => `
          <label>
            <input type="radio" name="answer" value="${opt}"> ${opt}
          </label>
        `).join('');
        document.getElementById('optionsList').innerHTML = optionsHTML;
        let startTime = localStorage.getItem(TIMER_KEY);
        if (!startTime) {
          startTime = Date.now();
          localStorage.setItem(TIMER_KEY, startTime);
        } else {
          startTime = parseInt(startTime, 10);
        }

        startTimer(startTime);
      });
  }

  function playBeep() {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);

    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
    gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);

    oscillator.start();
    oscillator.stop(audioCtx.currentTime + 0.3);
  }

  function submitAnswer() {
  clearInterval(timer);
  localStorage.removeItem(TIMER_KEY);

  const selected = document.querySelector('input[name="answer"]:checked');
  const answer = selected ? selected.value : null;
  if (!answer) {
    alert("Please select one of the options before submitting.");
    return;
  }

  fetch('/image/submit', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ answer: answer })
  })
  .then(res => res.json())
  .then(response => {
    const result = response.result;

    playBeep();

    let message = '';
    let headerColor = '';
    let messageColor = '';

    if (result === "correct") {
      message = "You Got it Correct";
      headerColor = "green";
      messageColor = "green";
    } else if (result === "wrong") {
      message = "You Got it Wrong";
      headerColor = "red";
      messageColor = "red";
    } else if (result === "timeout") {
      message = "Time's Up!";
      headerColor = "gray";
      messageColor = "gray";
    }

    document.querySelector('.question-box').style.display = "none";
    document.querySelector('.footer').style.display = "none";

    document.getElementById('resultBox').style.display = "block";
    document.getElementById('resultHeader').style.backgroundColor = headerColor;
    document.getElementById('resultMessage').style.color = messageColor;
    document.getElementById('resultMessage').textContent = message;
  });
}


  loadQuestion();
</script>

</body>
</html>
